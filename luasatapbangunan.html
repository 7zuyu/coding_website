ini kode html
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Tag <head> berisi informasi penting terkait halaman web -->
    <meta charset="UTF-8"> <!-- Mendefinisikan pengkodean karakter -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Menyesuaikan tampilan sesuai lebar perangkat -->
    <title>Perhitungan Luas Atap Bangunan</title> <!-- Judul halaman web -->
    <!-- Stylesheets dan Favicon -->
    <link rel="stylesheet" href="luasatapbangunan.css"> <!-- Menambahkan stylesheet khusus -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/><!-- Menambahkan ikon dari Font Awesome -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/> <!-- Menambahkan library Leaflet untuk peta -->
    <link rel="icon" href="pcu.png" type="image/x-icon"> <!-- Menambahkan favicon -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script> <!-- Menambahkan script Leaflet -->
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script> <!-- Menambahkan script untuk fitur menggambar pada peta -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/5.1.6/turf.min.js"></script> <!-- Menambahkan script Turf.js untuk analisis spasial -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> <!-- Menambahkan script HTML2Canvas untuk mengonversi elemen HTML menjadi gambar -->
  </head>  
<body>
 
  <header>
    <h1>Menghitung Luasan Atap Bangunan</h1>

      <button id="startDrawing">Mulai Menggambar</button> <!-- Tombol untuk memulai menggambar pada peta -->
      <button id="finishDrawing">Selesai Menggambar</button> <!-- Tombol untuk menyelesaikan menggambar pada peta -->
      <button id="osmTiles">Tampilkan OSM Tiles</button> <!-- Tombol untuk menampilkan peta OSM -->
      <button id="cartoTiles">Tampilkan CARTO Tiles</button> <!-- Tombol untuk menampilkan peta CARTO -->
      <label for="month">Pilih Bulan:</label> <!-- Label untuk opsi pemilihan bulan -->
      <select id="month">
        <option value="January">January</option>
        <option value="February">February</option>
        <option value="March">March</option>
        <option value="April">April</option>
        <option value="May">May</option>
        <option value="June">June</option>
        <option value="July">July</option>
        <option value="August">August</option>
        <option value="September">September</option>
        <option value="October">October</option>
        <option value="November">November</option>
        <option value="December">December</option>
      </select>
      <label for="year">Pilih Tahun:</label>
      <select id="year">
        <option value="2011">2011</option>
        <option value="2012">2012</option>
        <option value="2013">2013</option>
        <option value="2014">2014</option>
        <option value="2015">2015</option>
        <option value="2016">2016</option>
        <option value="2017">2017</option>
        <option value="2018">2018</option>
        <option value="2019">2019</option>
        <option value="2020">2020</option>
      </select>
    </div>
  </header>
  <section class="home">
    <div id="result"></div>
    <div id="mapContainer">
    <div id="map"></div>
    </div>    
    <div id="intensity-result" style="position: relative; width: 100%; max-width: 300px; margin: auto; display: none;">
      <h2>Data GHI</h2>
      <button id="close-intensity" style="position: absolute; top: 0; right: 0;">&times;</button>
      <ul id="intensity-list" class="ghi-popup-content"></ul>
    </div>
    <div id="plot-container" style="position: relative; display: none;">
      <h2>Intensity Plot</h2>
      <button id="close-plot" style="position: absolute; top: 0; right: 0;">&times;</button>
      <img id="intensity-plot" alt="Intensity Plot" />
    </div>
    <div id="mapImageContainer"></div>
  </section>
  <footer>
    <div class="bottom">
        <p id="area-info">Luas Keseluruhan: 0 m<sup>2</sup></p>
        <p id="luas-keseluruhan">Luas Keseluruhan: 0 m<sup>2</sup></p>
        <p id="luas-tertentu">Luas Tertentu: 0 m<sup>2</sup></p>
        <p id="persentase-luas">Persentase Luas: 0%</p>
        <!-- Tambahkan elemen ini untuk menampilkan total GHI -->
        <p id="total-ghi">Total GHI: 0 kWh/m<sup>2</sup>/month</p>
        
    </div>
</footer>
  <style>
    /* Style untuk animasi loading */
    #loading {
      display: none; /* Awalnya disembunyikan */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1000;
      text-align: center;
      font-size: 24px;
      color: #000;
      display: flex;
      justify-content: center;
      flex-direction: column;
    }

    #loading .spinner {
      border: 16px solid #f3f3f3;
      border-radius: 50%;
      border-top: 16px solid #3498db;
      width: 120px;
      height: 120px;
      margin-bottom: 20px; /* Tambahkan margin bawah untuk memberi jarak antara spinner dan teks */
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    html, body {
      height: 100%;
      margin: 0;
    }
    .leaflet-container {
      height: 70%;
      width: 100%;
    }
    #close-plot, #close-intensity {
      background: none;
      border: none;
      font-size: 3em;
      cursor: pointer;
    }
    #close-plot:hover, #close-intensity:hover {
      color: red;
    }
    #intensity-result {
      position: relative;
      width: 100%;
      max-width: 310px;
      margin: auto;
      display: none;
      overflow-y: scroll;
      max-height: 700px;
    }
    #intensity-list {
      padding: 0;
      margin: 0;
      list-style-type: none;
    }
    .ghi-popup-content {
      font-size: 0.8em; /* Adjust the font size as needed */
    }
    /* Memperbesar tombol zoom */
    .leaflet-control-zoom-in,
    .leaflet-control-zoom-out {
    font-size: 30px !important; /* Ukuran font ditingkatkan */
    width: 40px !important; /* Lebar tombol ditingkatkan */
    height: 40px !important; /* Tinggi tombol ditingkatkan */
    line-height: 40px !important; /* Tinggi garis ditingkatkan untuk sentralisasi teks */
    }
    /* Memperbesar kontrol gambar */
    .leaflet-draw-toolbar a {
      width: 40px !important; /* Lebar tombol ditingkatkan */
      height: 40px !important; /* Tinggi tombol ditingkatkan */
      line-height: 40px !important; /* Tinggi garis ditingkatkan untuk sentralisasi teks */
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 30px; /* ukuran ikon */
    }
    .leaflet-draw-toolbar a i,
    .leaflet-draw-toolbar a svg {
        width: 30px !important; /* Lebar ikon ditingkatkan */
        height: 30px !important; /* Tinggi ikon ditingkatkan */
    }
    /* Tambahkan ini untuk memperbesar ikon dalam tombol draw toolbar */
    .leaflet-draw-toolbar a svg {
        width: 40px !important;
        height: 40px !important;
    }
  </style>
  <script>
    const map = L.map('map').setView([-7.33, 112.72], 18);

    const osmTiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 22,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    });

    const cartoTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
      maxZoom: 22,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
    });

    // Add initial tile layer to the map
    osmTiles.addTo(map);

    document.getElementById('osmTiles').onclick = function() {
      map.removeLayer(cartoTiles);
      osmTiles.addTo(map);
    };

    document.getElementById('cartoTiles').onclick = function() {
      map.removeLayer(osmTiles);
      cartoTiles.addTo(map);
    };
    const marker = L.marker([-7.31, 112.72]).addTo(map)

    .bindPopup('<b>Hello!</b><br />I am in Surabaya.');
    const popup = L.popup();
    marker.on('popupopen', function() {
      const popup = this.getPopup();
      const latlng = this.getLatLng();
      const selectedMonth = document.getElementById('month').value;
      const selectedYear = document.getElementById('year').value;
      const data = {
          latitude: latlng.lat,
          longitude: latlng.lng,
          month: selectedMonth,
          year: selectedYear
      };

      fetch('http://localhost:5000/get_intensitas', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
          return response.json();
      })
      .then(data => {
          popup.setContent(`Lat: ${latlng.lat.toFixed(2)}, Lon: ${latlng.lng.toFixed(2)}.<br>GHI: ${data.intensitas.toFixed(2)} Wh/m2`);
      })
      .catch(error => {
          console.error('Error:', error);
          popup.setContent('Failed to fetch intensity data.');
      });
    });

    marker.openPopup();

    const drawnItems = new L.FeatureGroup();
    const drawControl = new L.Control.Draw({
      draw: {
          polygon: true,
          polyline: false,
          circle: true,
          marker: false,
          circlemarker: false,
          rectangle: true,
      },
      edit: {
          featureGroup: drawnItems,
      },
    });

    map.addLayer(drawnItems);
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (e) {
        const layer = e.layer;
        drawnItems.addLayer(layer);
    });

    document.getElementById('startDrawing').onclick = function() {
        map.addLayer(drawnItems);
        map.addControl(drawControl);
    };

    function layerToGeoJSON(layer) {
      if (layer instanceof L.Circle) {
          const latlng = layer.getLatLng();
          const radius = layer.getRadius();
          const options = { steps: 64, units: 'meters' }; // Adjust the number of steps for more detail
          const circlePolygon = turf.circle([latlng.lng, latlng.lat], radius, options);
          return circlePolygon;
      } else {
          return layer.toGeoJSON();
      }
    }

    //let totalArea = 0;
    
    let lastDrawnPolygon = null;

    function calculateTotalArea() {
      totalArea = 0;
      drawnItems.eachLayer(function(layer) {
          const geojson = layerToGeoJSON(layer);
          const area = turf.area(geojson);
          totalArea += area;
      });
    }

    // Fungsi untuk menyimpan gambar peta yang sudah dipotong berdasarkan batas poligon
      function saveCroppedMapImage(bounds) {
      const mapContainer = document.getElementById('mapContainer');
      
      // Mendapatkan semua titik dari polygon yang digambar
      const polygonLatLngs = lastDrawnPolygon.getLatLngs()[0];
      let minLat = Infinity;
      let minLng = Infinity;
      let maxLat = -Infinity;
      let maxLng = -Infinity;
    
      // Menghitung batas terkecil dan terbesar dari semua titik dalam polygon
      polygonLatLngs.forEach(latlng => {
        if (latlng.lat < minLat) minLat = latlng.lat;
        if (latlng.lng < minLng) minLng = latlng.lng;
        if (latlng.lat > maxLat) maxLat = latlng.lat;
        if (latlng.lng > maxLng) maxLng = latlng.lng;
      });
    
      const topLeft = map.latLngToContainerPoint([maxLat, minLng]); // Titik sudut kiri atas
      const bottomRight = map.latLngToContainerPoint([minLat, maxLng]); // Titik sudut kanan bawah
      const width = bottomRight.x - topLeft.x; // Hitung lebar dalam piksel
      const height = bottomRight.y - topLeft.y; // Hitung tinggi dalam piksel
    
      html2canvas(mapContainer, {
        useCORS: true, // Untuk mengatasi masalah cross-origin
        scrollX: -window.scrollX,
        scrollY: -window.scrollY,
        windowWidth: window.innerWidth,
        windowHeight: window.innerHeight,
        width: width,
        height: height,
        x: topLeft.x,
        y: topLeft.y,
      }).then(canvas => {
        // Konversi canvas yang sudah dipotong ke base64 string
        const imageData = canvas.toDataURL('image/png');
    
        // Kirim base64 string gambar ke server
        sendImageToServer(imageData);
      });
    }
    
    // Fungsi untuk mengunggah gambar yang sudah dipotong ke server
    function sendImageToServer(imageData) {
      fetch('http://localhost:5000/save_cropped_map_image', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ image: imageData })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Gagal menyimpan gambar ke server');
        }
        return response.json();
      })
      .then(data => {
        console.log(data.message); // Pesan sukses dari server
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }

   document.getElementById('finishDrawing').onclick = function() {
    const selectedMonth = document.getElementById('month').value;
    const selectedYear = document.getElementById('year').value;

    // Pengecekan apakah peta saat ini adalah Carto Tiles
    if (!map.hasLayer(cartoTiles)) {
        alert("Anda harus menampilkan CARTO Tiles untuk menyelesaikan menggambar.");
        return;
    }

    map.removeControl(drawControl);
    map.removeLayer(drawnItems);

    const features = drawnItems.getLayers().map(layer => layerToGeoJSON(layer));
    lastDrawnPolygon = features.length > 0 ? drawnItems.getLayers().slice(-1)[0] : null; // Ambil poligon terakhir

    sendDataToServer(features, selectedMonth, selectedYear);
    const polygonCoords = features[0].geometry.coordinates[0]; // Misalnya mengambil koordinat dari fitur pertama

    savePolygonImage(features);
    calculateTotalArea();
    const bounds = lastDrawnPolygon.getBounds();
    saveCroppedMapImage(bounds); // Call saveCroppedMapImage with the bounds of the last drawn polygon

    // Tampilkan animasi loading
    //document.getElementById('loading').style.display = 'block';
    // Menjalankan fetchAnalyzePolygonImage setelah 1 detik
    setTimeout(function() {
        // Panggil fungsi ketika diperlukan, misalnya setelah penghitungan selesai
        fetchAnalyzePolygonImage();
    }, 1000); // 1000 ms = 1 detik

    // Update footer data
    const formattedArea = totalArea > 1000000 ? (totalArea / 1000000).toFixed(2) + ' km²' : totalArea.toFixed(2) + ' m²';
    document.getElementById('luas-keseluruhan').textContent = `Luas Keseluruhan: ${formatNumber(formattedArea)}`;

    setTimeout(function() {
        window.open(`result.html?month=${selectedMonth}&year=${selectedYear}`, '_blank');
        // Sembunyikan animasi loading setelah membuka halaman baru
        //document.getElementById('loading').style.display = 'none';
    }, 5000); // Waktu dihitung dalam milidetik, 5000 untuk 5 detik
};


    function updateAreaInfo(area) {
      const areaInfo = document.getElementById('area-info');
      let formattedArea;
      let unit;
    
      if (area > 1000000) {
        formattedArea = formatNumber((area / 1000000).toFixed(2));
        unit = 'km²';
      } else {
        formattedArea = formatNumber(area.toFixed(2));
        unit = 'm²';
      }
      areaInfo.textContent = `Luas Keseluruhan: ${formattedArea} ${unit}`;
    }


    // Modifikasi sendDataToServer untuk menyimpan poligon sebagai gambar sebelum mengirimnya ke server
    function sendDataToServer(data, selectedMonth, selectedYear) {
      const drawnItemsLayers = drawnItems.getLayers();
      if (drawnItemsLayers.length === 0) {
          console.error("No polygon has been drawn.");
          return;
      }

      const polygonLayer = drawnItemsLayers[0]; // Ambil poligon pertama (asumsikan hanya ada satu poligon yang digambar)
      const geoJSONLayer = layerToGeoJSON(polygonLayer);

      if (!geoJSONLayer.geometry.coordinates[0] || geoJSONLayer.geometry.coordinates[0].length === 0) {
          console.error("Invalid polygon coordinates.");
          return;
      }

      fetch('http://localhost:5000/get_coordinates_with_intensity', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              features: [geoJSONLayer],
              month: selectedMonth,
              year: selectedYear
          })
      })
      .then(response => response.json())
      .then(data => {
        
            console.log(data);
            displayIntensityData(data.intensity_data);
        
            // Update footer with total GHI
            document.getElementById('total-ghi').textContent = `Total GHI: ${formatNumber(data.total_GHI.toFixed(2))} kWh/m²/month`;
      })
      .catch(error => {
          console.error('Error:', error);
      });

      fetch('http://localhost:5000/get_intensity_plot', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              features: [geoJSONLayer],
              month: selectedMonth,
              year: selectedYear
          })
      })
      .then(response => response.blob()) 
      .then(blob => {
          const url = URL.createObjectURL(blob);
          const img = document.getElementById('intensity-plot');
          img.src = url;
          document.getElementById('plot-container').style.display = 'block'; // Show plot-container
      })
      .catch(error => {
          console.error('Error fetching intensity plot:', error);
      });  
    }

    function displayIntensityData(intensityData) {
      const intensityResultDiv = document.getElementById('intensity-result');
      intensityResultDiv.style.display = 'block'; 
      const intensityList = document.getElementById('intensity-list');
      intensityList.innerHTML = ''; 

      Object.entries(intensityData).forEach(([coord, intensity]) => {
          const [latitude, longitude] = coord.split(',').map(parseFloat);
          const listItem = document.createElement('li');
          listItem.textContent = `Lat: ${latitude.toFixed(2)}, Lon: ${longitude.toFixed(2)}, GHI: ${formatNumber(intensity)} Wh/m2`;
          intensityList.appendChild(listItem);
      });
    }

    function fetchAnalyzePolygonImage() {
      const selectedMonth = document.getElementById('month').value;
      const selectedYear = document.getElementById('year').value;
  
      // Mendapatkan koordinat polygon terakhir yang digambar
      const polygonLayer = drawnItems.getLayers().slice(-1)[0];
      const geoJSONLayer = layerToGeoJSON(polygonLayer);
  
      // Membuat objek data untuk dikirim ke server
      const data = {
          features: [geoJSONLayer], // Mengirim hanya polygon terakhir
          month: selectedMonth,
          year: selectedYear
      };
  
      // Mengirim permintaan POST ke server
      fetch('http://localhost:5000/analyze_polygon_image', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('Gagal melakukan analisis polygon image');
          }
          return response.json();
      })
      .then(result => {
          // Lakukan sesuatu dengan hasil analisis yang diterima dari server
          console.log(result);
          // Mengganti nilai HTML dengan persentase luas yang diterima dari server
          document.getElementById('persentase-luas').textContent = result.persentase_luas.toFixed(2) + '%';
          
          let areaTertentu = totalArea * result.persentase_luas / 100;
          if (areaTertentu > 1000000) {
              // Ubah unit menjadi km²
              areaTertentu = (areaTertentu / 1000000).toFixed(2) + ' km²';
          } else {
              // Biarkan unit tetap m²
              areaTertentu = areaTertentu.toFixed(2) + ' m²';
          }
          document.getElementById('luas-tertentu').textContent = `Luas Tertentu: ${formatNumber(areaTertentu)}`;
      })
      .catch(error => {
          console.error('Error:', error);
      });
  }
  
  
  
      function savePolygonImage(features) {
        fetch('http://localhost:5000/save_polygon_image', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ features: features })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Gagal menyimpan gambar polygon');
          }
          return response.json();
        })
        .then(data => {
          console.log(data.message); // Pesan sukses dari server
        })
        .catch(error => {
          console.error('Error:', error);
        });
      }

    function onMapClick(e) {
      const selectedMonth = document.getElementById('month').value;
      const selectedYear = document.getElementById('year').value;

      const data = {
        latitude: e.latlng.lat,
        longitude: e.latlng.lng,
        month: selectedMonth,
        year: selectedYear
      };

      fetch('http://localhost:5000/get_intensitas', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        popup
          .setLatLng(e.latlng)
          .setContent(`Lat:${e.latlng.lat.toFixed(2)}, Long:${e.latlng.lng.toFixed(2)} <br>GHI : ${data.intensitas.toFixed(2)} Wh/m2`)
          .openOn(map);
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }

    map.on('click', onMapClick);

    document.getElementById('close-plot').onclick = function() {
      document.getElementById('plot-container').style.display = 'none';
    };

    document.getElementById('close-intensity').onclick = function() {
        document.getElementById('intensity-result').style.display = 'none';
    };

    function calculateArea(layer) {
      if (layer instanceof L.Polygon) {
        const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
        return area;
      } else if (layer instanceof L.Circle) {
        const radius = layer.getRadius();
        return Math.PI * radius * radius;
      } else {
        console.error('Layer bukan merupakan polygon atau lingkaran.');
        return 0;
      }
    }

    function formatNumber(number) {
      return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function updateAreaInfo(area) {
      const areaInfo = document.getElementById('area-info');
      let formattedArea;
      let unit;
    
      if (area > 1000000) {
        formattedArea = formatNumber((area / 1000000).toFixed(2));
        unit = 'km²';
      } else {
        formattedArea = formatNumber(area.toFixed(2));
        unit = 'm²';
      }
      areaInfo.textContent = `Luas Keseluruhan: ${formattedArea} ${unit}`;
    }
  
    map.on(L.Draw.Event.CREATED, function (e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);
      const area = calculateArea(layer);
      updateAreaInfo(area);
    });

    drawnItems.on('edit', function (e) {
      const layers = e.layers;
      layers.eachLayer(function (layer) {
          const area = calculateArea(layer);
          updateAreaInfo(area);
      });
    });
  </script>
  <!-- <div>
    <div id="loading">
      <div class="spinner"></div>
      <p>Loading...</p>
  </div> -->
</body>
</html>
