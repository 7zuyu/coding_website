<!DOCTYPE html>
<html>
<head>
    <title>Draw and Save Shapes</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
    <script src="https://rawgit.com/mapbox/leaflet-image/gh-pages/leaflet-image.js"></script>
</head>
<body>
    <div id="map" style="width: 100%; height: 600px;"></div>
    <button id="save-button">Save Shape</button>

    <script>
        var map = L.map('map').setView([-7.33, 112.72], 16);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18
        }).addTo(map);

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        var lastDrawnLayer;

        map.on(L.Draw.Event.CREATED, function (event) {
            var layer = event.layer;
            drawnItems.addLayer(layer);
            lastDrawnLayer = layer;
        });

        document.getElementById('save-button').addEventListener('click', function () {
            if (lastDrawnLayer) {
                var bounds = lastDrawnLayer.getBounds();
                var bbox = {
                    north: bounds.getNorth(),
                    south: bounds.getSouth(),
                    east: bounds.getEast(),
                    west: bounds.getWest()
                };

                leafletImage(map, function(err, canvas) {
                    if (err) {
                        console.error('Error capturing map:', err);
                        return;
                    }

                    var imgData = canvas.toDataURL();
                    fetch('http://localhost:5000/save_map_image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ imageData: imgData, bbox: bbox })
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            } else {
                alert('No shape drawn!');
            }
        });
    </script>
</body>
</html>
